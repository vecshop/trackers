<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Add meta tags for SEO and mobile -->
  <meta name="description" content="Track your habits, todos and income with this productivity app">
  <meta name="theme-color" content="#533483">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/icons/192x192.png">
  
  <!-- Add version to prevent caching -->
  <meta name="version" content="2.0.0">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Habit & Income Tracker</title>
    <link
      rel="icon"
      href="https://cdn-icons-png.flaticon.com/512/1047/1047711.png"
      type="image/png"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link rel="manifest" href="/manifest.json" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --primary-color: #26282b;
        --btn-color: #1d3be6;
        --card-bg: #f4f4f4;
        --secondary-color: #533483;
        --shadow-color: rgba(0, 0, 0, 0.2);
        --accent-color: #e94560;
        --digital-color: #006363;
        --background-color: #f4f4f4;
        --hover-color: #2a2b32;
      }

      body.dark-mode {
        --primary-color: #3e5bff;
        --secondary-color: #1d3be6;
        --btn-color: #3e5bff;
        --digital-color: #64ffff;
        --background-color: #343541;
        --card-bg: #444654;
        --text-color: #ffffff;
        --border-color: #565869;
        --hover-color: #2a2b32;
        --shadow-color: rgba(0, 0, 0, 0.2);
        --pricing-full-free: #3cd682;
        --pricing-free-credits: #2da0ff;
        --pricing-free-limits: #0734ff;
        --pricing-paid: #f4b836;
      }

      body {
        background-color: var(--background-color);
        color: var(--text-color);
        font-family: "Inter", sans-serif;
      }

      .card {
        background-color: var(--card-bg);
        border-color: var(--border-color);
        box-shadow: 0 4px 6px var(--shadow-color);
        color: var(--text-color);
        border-radius: 10px;
        margin-bottom: 5px;
      }

      .modal-content {
        background-color: var(--card-bg);
        border-color: var(--border-color);
        box-shadow: 0 4px 6px var(--shadow-color);
        color: var(--text-color);
        border-radius: 10px;
        max-height: 90vh;
        overflow-y: auto;
        scrollbar-width: none;
        scrollbar-color: transparent transparent;
      }

      .modal {
        scrollbar-color: transparent transparent;
        scrollbar-width: none;
      }

      .table-responsive th,
      .table-responsive td {
        background-color: var(--card-bg);
        color: var(--text-color);
      }

      .habit-card p,
      .btn-close {
        color: var(--text-color);
      }

      .nav-tabs .nav-link.active {
        background-color: var(--primary-color);
        color: white;
      }

      .btn-primary {
        background-color: var(--btn-color);
        border-color: var(--primary-color);
      }

      .btn-primary.dark-mode {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
      }

      .btn-primary:hover {
        background-color: var(--hover-color);
      }

      .habit-card,
      .todo-card {
        background: var(--card-bg);
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 10px;
        color: var(--text-color);
        box-shadow: 0 4px 6px var(--shadow-color);
        transition: all 0.5s ease;
        position: relative;
      }

      .completed-card {
        background: rgba(52, 255, 130, 0.329);
      }
      .failed-card {
        background: rgba(255, 82, 52, 0.329);
      }

      .completed-title,
      .failed-title {
        text-decoration: line-through;
        transition: text-decoration 0.3s ease;
        animation: bigging 0.5s ease;
      }

      .fully-completed-card {
        background: rgba(
          40,
          167,
          69,
          0.2
        ) !important; /* Using Bootstrap's success green with opacity */
        border: 1px solid rgba(40, 167, 69, 0.5);
      }

      .move-down {
        opacity: 0;
        transform: translateY(100%);
      }

      .move-up {
        animation: slideUp 0.5s ease forwards;
      }

      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes bigging {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }

      .checkbox-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .day-checkbox {
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
      }

      .day-checkbox.checked {
        background-color: var(--accent-color);
        color: white;
      }

      .day-checkbox.failed {
        background-color: #808080; /* Gray color */
        color: white;
        opacity: 0.7;
      }

      .btn-fail {
        background-color: #ff4d4d;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 0.5rem 1rem;
        cursor: pointer;
        margin-bottom: 10px;
      }

      .wishlist-card {
        width: 200px;
        margin: 10px;
      }

      .wishlist-image {
        height: 150px;
        object-fit: cover;
      }

      .expense-type-card {
        cursor: pointer;
        width: 120px;
        border: 1px solid var(--border-color);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .expense-type-card:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .expense-type-card.selected {
        border-color: var(--primary-color);
        background-color: var(--primary-color);
        color: white;
      }

      #totalBalance {
        font-family: "Digital-7 Mono", monospace;
        font-size: 2rem;
        color: var(--text-color);
        transition: transform 0.3s ease-in-out;
      }

      #totalBalance.animated {
        transform: scale(1.08);
        color: var(--digital-color);
      }

      #incomeChart {
        max-height: 300px;
      }

      #monthlyChart {
        max-height: 300px;
        width: 100%;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }
        #monthlyChart {
          max-height: 200px;
          width: 100%;
        }
        #incomeChart {
          max-height: 200px;
        }
        .nav-tabs {
          display: flex;
          justify-content: space-between;
          width: 100%;
        }

        .nav-tabs .nav-item {
          flex: 1;
          text-align: center;
        }

        .nav-tabs .nav-link {
          display: flex;
          flex-direction: column;
          align-items: center;
          padding: 8px 4px;
          font-size: 0.6rem;
        }

        .nav-tabs .nav-link i {
          font-size: 1.2rem;
          margin-bottom: 2px;
        }

        .container {
          padding: 10px;
          padding-top: 10px !important;
        }
      }
    </style>
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("/service-worker.js")
            .then((registration) => {
              console.log(
                "Service Worker registered with scope:",
                registration.scope
              );
            })
            .catch((error) => {
              console.error("Service Worker registration failed:", error);
            });
        });
      }
    </script>
  </head>
  <body>
    <!-- Verify Access Check -->
    <script>
      if (!sessionStorage.getItem("verified")) {
        window.location.href = "verify.html";
      }
    </script>

    <div class="container py-4">
      <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="dashboard-tab"
            data-bs-toggle="tab"
            data-bs-target="#dashboard"
            type="button"
          >
            <i class="bi bi-bar-chart-fill"></i>
            Dashboard
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="habits-tab"
            data-bs-toggle="tab"
            data-bs-target="#habits"
            type="button"
          >
            <i class="bi bi-calendar-check-fill"></i>
            Habits
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            translate="no"
            class="nav-link"
            id="todos-tab"
            data-bs-toggle="tab"
            data-bs-target="#todos"
            type="button"
          >
            <i class="bi bi-ui-checks"></i>
            To Do
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="income-tab"
            data-bs-toggle="tab"
            data-bs-target="#income"
            type="button"
          >
            <i class="bi bi-cash-stack"></i>
            Income
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="settings-tab"
            data-bs-toggle="tab"
            data-bs-target="#settings"
            type="button"
          >
            <i class="bi bi-gear-fill"></i>
            Settings
          </button>
        </li>
      </ul>

      <div class="tab-content" id="myTabContent">
        <!-- Dashboard Tab -->
        <div class="tab-pane fade show active" id="dashboard">
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Monthly Analytics</h5>
                  <canvas id="monthlyChart"></canvas>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Income vs Expenses</h5>
                  <canvas id="incomeChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="row mt-4">
            <div class="col-12">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Recent Transactions</h5>
                  <div class="table-responsive">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>Type</th>
                          <th>Amount</th>
                          <th>Description</th>
                        </tr>
                      </thead>
                      <tbody id="dashboardHistoryTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Habits Tab -->
        <div class="tab-pane fade" id="habits">
          <button
            class="btn btn-primary mb-3"
            data-bs-toggle="modal"
            data-bs-target="#habitModal"
          >
            Add New Habit
          </button>
          <div id="habitsContainer"></div>
        </div>

        <!-- Todos Tab -->
        <div class="tab-pane fade" id="todos">
          <button
            class="btn btn-primary mb-3"
            data-bs-toggle="modal"
            data-bs-target="#todoModal"
          >
            Add New Todo
          </button>
          <div id="todosContainer"></div>
        </div>

        <!-- Income Tab -->
        <div class="tab-pane fade" id="income">
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Total Balance</h5>
                  <h2 id="totalBalance">Rp 0</h2>
                  <div class="btn-group">
                    <button
                      class="btn btn-success"
                      data-bs-toggle="modal"
                      data-bs-target="#incomeModal"
                    >
                      Add Income
                    </button>
                    <button
                      class="btn btn-danger"
                      data-bs-toggle="modal"
                      data-bs-target="#expenseModal"
                    >
                      Add Expense
                    </button>
                    <button
                      class="btn btn-info"
                      data-bs-toggle="modal"
                      data-bs-target="#historyModal"
                    >
                      View History
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Wishlist</h5>
                  <button
                    class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#wishlistModal"
                  >
                    Add Wishlist Item
                  </button>
                  <div
                    id="wishlistContainer"
                    class="d-flex flex-wrap mt-3"
                  ></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Tab Settings -->
        <div class="tab-pane fade" id="settings">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Appearance</h5>
              <div class="form-check form-switch">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="darkModeToggle"
                />
                <label class="form-check-label" for="darkModeToggle"
                  >Dark Mode</label
                >
              </div>
            </div>
          </div>

          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title">Habits Management</h5>
              <div class="d-grid gap-2">
                <button class="btn btn-warning" onclick="resetAllHabits()">
                  Reset All Habits Progress
                </button>
                <button class="btn btn-danger" onclick="deleteAllHabits()">
                  Delete All Habits
                </button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Todos Management</h5>
              <div class="d-grid gap-2">
                <button class="btn btn-warning" onclick="resetAllTodos()">
                  Reset All Todos Progress
                </button>
                <button class="btn btn-danger" onclick="deleteAllTodos()">
                  Delete All Todos
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modals -->
    <!-- Habit Modal -->
    <div class="modal fade" id="habitModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New Habit</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div id="habitForms"></div>
            <button class="btn btn-secondary" id="addHabitForm">
              <i class="bi bi-plus"></i> Add Another Habit
            </button>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="saveHabits">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Todo Modal -->
    <div class="modal fade" id="todoModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New Todo</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div id="todoForms"></div>
            <button class="btn btn-secondary" id="addTodoForm">
              <i class="bi bi-plus"></i> Add Another Todo
            </button>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="saveTodos">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Income Modal -->
    <div class="modal fade" id="incomeModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Income</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Amount (Rp)</label>
              <input type="number" class="form-control" id="incomeAmount" />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="saveIncome">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Expense Modal -->
    <div class="modal fade" id="expenseModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Expense</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Amount (Rp)</label>
              <input type="number" class="form-control" id="expenseAmount" />
            </div>
            <div class="mb-3">
              <label class="form-label">Reason</label>
              <input type="text" class="form-control" id="expenseReason" />
            </div>
            <div class="mb-3">
              <label class="form-label">Type</label>
              <div id="expenseTypeOptions" class="d-flex flex-wrap gap-2">
                <div class="card expense-type-card" data-value="food">
                  <div class="card-body text-center">
                    <i class="bi bi-egg-fried fs-3"></i>
                    <p>Food</p>
                  </div>
                </div>
                <div class="card expense-type-card" data-value="transport">
                  <div class="card-body text-center">
                    <i class="bi bi-truck fs-3"></i>
                    <p>Transport</p>
                  </div>
                </div>
                <div class="card expense-type-card" data-value="entertainment">
                  <div class="card-body text-center">
                    <i class="bi bi-film fs-3"></i>
                    <p>Entertainment</p>
                  </div>
                </div>
                <!-- Additional Categories -->
                <div class="card expense-type-card" data-value="health">
                  <div class="card-body text-center">
                    <i class="bi bi-activity fs-3"></i>
                    <p>Health</p>
                  </div>
                </div>
                <div class="card expense-type-card" data-value="education">
                  <div class="card-body text-center">
                    <i class="bi bi-book fs-3"></i>
                    <p>Education</p>
                  </div>
                </div>
                <div class="card expense-type-card" data-value="utilities">
                  <div class="card-body text-center">
                    <i class="bi bi-lightbulb fs-3"></i>
                    <p>Utilities</p>
                  </div>
                </div>
                <div class="card expense-type-card" data-value="shopping">
                  <div class="card-body text-center">
                    <i class="bi bi-bag fs-3"></i>
                    <p>Shopping</p>
                  </div>
                </div>
                <div class="card expense-type-card" data-value="other">
                  <div class="card-body text-center">
                    <i class="bi bi-three-dots fs-3"></i>
                    <p>Other</p>
                  </div>
                </div>
              </div>
              <input type="hidden" id="expenseType" />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="saveExpense">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Wishlist Modal -->
    <div class="modal fade" id="wishlistModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Wishlist Item</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Item Name</label>
              <input type="text" class="form-control" id="wishlistName" />
            </div>
            <div class="mb-3">
              <label class="form-label">Price (Rp)</label>
              <input type="number" class="form-control" id="wishlistPrice" />
            </div>
            <div class="mb-3">
              <label class="form-label">Thumbnail URL</label>
              <input type="text" class="form-control" id="wishlistImage" />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" id="saveWishlist">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Transaction History</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="d-flex justify-content-end mb-3">
              <button class="btn btn-danger" id="clearHistory">
                <i class="bi bi-trash"></i> Clear All Histories
              </button>
            </div>
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Description</th>
                  </tr>
                </thead>
                <tbody id="historyTableBody"></tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- validation modal -->
    <div class="modal fade" id="validationModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirmation</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <p id="validationMessage"></p>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              id="validationConfirm"
            >
              Confirm
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Initialize data structures
      let habits = JSON.parse(localStorage.getItem("habits")) || [];
      let todos = JSON.parse(localStorage.getItem("todos")) || [];
      let transactions = JSON.parse(localStorage.getItem("transactions")) || [];
      let wishlist = JSON.parse(localStorage.getItem("wishlist")) || [];
      let balance = parseFloat(localStorage.getItem("balance")) || 0;

      function checkForUpdates() {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js').then(registration => {
        setInterval(() => {
          registration.update();
        }, 60 * 1000);

        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'activated') {
              window.location.reload();
            }
          });
        });
      });

      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!refreshing) {
          refreshing = true;
          window.location.reload();
        }
      });
    }
  }

  window.addEventListener('load', checkForUpdates);

      // Chart instances
      let charts = {
        monthly: null,
        income: null,
      };

      function clearCharts() {
        Object.values(charts).forEach((chart) => {
          if (chart instanceof Chart) {
            chart.destroy();
          }
        });
        charts = {
          monthly: null,
          income: null,
        };
      }

      // Dashboard Charts
      function updateDashboard() {
        clearCharts(); // Clear all charts before rendering
        renderMonthlyChart();
        renderIncomeChart();
        updateTransactionHistory();
      }

      function renderMonthlyChart() {
        const canvas = document.getElementById("monthlyChart");
        if (!canvas) return;

        if (charts.monthly) {
          charts.monthly.destroy();
        }

        const ctx = canvas.getContext("2d");
        const today = new Date();
        const labels = Array.from({ length: 30 }, (_, i) => {
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          return d.toLocaleDateString();
        }).reverse();

        const habitData = labels.map(() => 0);
        const todoData = labels.map(() => 0);

        habits.forEach((habit) => {
          habit.progress.forEach((status, index) => {
            if (status === true) {
              // Only count true, not "failed"
              habitData[index]++;
            }
          });
        });

        todos.forEach((todo) => {
          todo.progress.forEach((status, index) => {
            if (status === true) {
              // Only count true, not "failed"
              todoData[index]++;
            }
          });
        });

        const textColor = getComputedStyle(document.body)
          .getPropertyValue("--text-color")
          .trim();

        charts.monthly = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Habits Completed",
                data: habitData,
                borderColor: "rgba(75, 192, 192, 1)",
                tension: 0.1,
                fill: false,
              },
              {
                label: "Todos Completed",
                data: todoData,
                borderColor: "rgba(255, 99, 132, 1)",
                tension: 0.1,
                fill: false,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false, // Allow custom height
            aspectRatio: 2, // Width:Height ratio (2:1)
            scales: {
              x: {
                ticks: {
                  color: textColor,
                },
              },
              y: {
                ticks: {
                  color: textColor,
                },
                beginAtZero: true,
              },
            },
            plugins: {
              legend: {
                labels: {
                  color: textColor,
                },
              },
            },
          },
        });
      }

      function renderIncomeChart() {
        const canvas = document.getElementById("incomeChart");
        if (!canvas) return;

        if (charts.income) {
          charts.income.destroy();
        }

        const ctx = canvas.getContext("2d");
        const monthlyData = {};

        transactions.forEach((transaction) => {
          const date = new Date(transaction.date);
          const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;

          if (!monthlyData[monthYear]) {
            monthlyData[monthYear] = {
              income: 0,
              expense: 0,
            };
          }

          if (transaction.type === "income") {
            monthlyData[monthYear].income += transaction.amount;
          } else {
            monthlyData[monthYear].expense += transaction.amount;
          }
        });

        const labels = Object.keys(monthlyData);
        const incomeData = labels.map((month) => monthlyData[month].income);
        const expenseData = labels.map((month) => monthlyData[month].expense);

        const textColor = getComputedStyle(document.body)
          .getPropertyValue("--text-color")
          .trim();

        charts.income = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["Income", "Expenses"], // Labels for the doughnut chart
            datasets: [
              {
                label: "Income vs Expenses",
                data: [
                  incomeData.reduce((a, b) => a + b, 0), // Sum of all income
                  expenseData.reduce((a, b) => a + b, 0), // Sum of all expenses
                ],
                backgroundColor: [
                  "rgba(75, 192, 192, 0.5)",
                  "rgba(255, 99, 132, 0.5)",
                ],
                borderColor: ["rgba(75, 192, 192, 1)", "rgba(255, 99, 132, 1)"],
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                labels: {
                  color: textColor,
                },
              },
            },
          },
        });
      }

      function updateDashboardTransactions() {
        const tbody = document.getElementById("dashboardHistoryTableBody");

        // Sort transactions by most recent
        const sortedTransactions = transactions
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .slice(0, 5); // Limit to the 5 most recent transactions

        // Populate the table
        tbody.innerHTML = sortedTransactions
          .map(
            (transaction) => `
        <tr>
          <td>${new Date(transaction.date).toLocaleDateString()}</td>
          <td>${
            transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)
          }</td>
          <td>${formatCurrency(transaction.amount)}</td>
          <td>${transaction.description}</td>
        </tr>
      `
          )
          .join("");
      }

      // Utility functions
      function formatCurrency(amount) {
        return new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
        }).format(amount);
      }

      function updateBalance() {
        localStorage.setItem("balance", balance.toString());
      }

      // Habits Management
      function createHabitForm() {
        const form = document.createElement("div");
        form.className = "habit-form mb-3";
        form.innerHTML = `
  <div class="mb-2">
      <input type="text" class="form-control habit-name" placeholder="Habit Name" required>
  </div>
  <div class="mb-2">
      <textarea class="form-control habit-description" placeholder="Description" required></textarea>
  </div>
  <div class="row">
      <div class="col">
          <input type="time" class="form-control habit-start" required>
      </div>
      <div class="col">
          <input type="time" class="form-control habit-end" required>
      </div>
  </div>
`;
        return form;
      }

      document.getElementById("addHabitForm").addEventListener("click", () => {
        const container = document.getElementById("habitForms");
        container.appendChild(createHabitForm());
      });

      document.getElementById("saveHabits").addEventListener("click", () => {
        const forms = document.querySelectorAll(".habit-form");

        if (isEditing && editingHabitId !== null) {
          // Update existing habit
          const form = forms[0]; // Only one form should exist in edit mode
          const habit = habits.find((h) => h.id == editingHabitId);

          habit.name = form.querySelector(".habit-name").value;
          habit.description = form.querySelector(".habit-description").value;
          habit.timeStart = form.querySelector(".habit-start").value;
          habit.timeEnd = form.querySelector(".habit-end").value;

          isEditing = false;
          editingHabitId = null; // Reset edit mode
        } else {
          // Add new habits
          forms.forEach((form) => {
            const habit = {
              id: Date.now() + Math.random(),
              name: form.querySelector(".habit-name").value,
              description: form.querySelector(".habit-description").value,
              timeStart: form.querySelector(".habit-start").value,
              timeEnd: form.querySelector(".habit-end").value,
              progress: Array(30).fill(false),
              createdAt: new Date().toISOString(),
            };
            habits.push(habit);
          });
        }

        localStorage.setItem("habits", JSON.stringify(habits));
        renderHabits();
        bootstrap.Modal.getInstance(
          document.getElementById("habitModal")
        ).hide();
        document.getElementById("habitForms").innerHTML = "";
      });

      function toggleHabitDay(habitId, day) {
        const habit = habits.find((h) => h.id == habitId);
        if (habit) {
          habit.progress[day] = !habit.progress[day];

          // Find the habit card
          const habitCard = document.querySelector(
            `.habit-card[data-id="${habitId}"]`
          );
          const habitTitle = habitCard.querySelector("h5");

          // Check if all checkboxes are completed
          const isCompleted = isFullyCompleted(habit.progress);

          // Add completed styles
          habitCard.classList.add("completed-card");
          habitTitle.classList.add("completed-title");

          // Trigger move down animation
          setTimeout(() => {
            habitCard.classList.add("move-down");

            // Only reorder if not fully completed
            if (!isFullyCompleted(habit.progress)) {
              habits = habits.filter((h) => h.id != habitId);
              // Insert before any fully completed habits
              const completedIndex = habits.findIndex((h) =>
                isFullyCompleted(h.progress)
              );
              if (completedIndex === -1) {
                habits.push(habit);
              } else {
                habits.splice(completedIndex, 0, habit);
              }
            } else {
              // If fully completed, move to end
              habits = habits.filter((h) => h.id != habitId);
              habits.push(habit);
            }

            // Re-render after animation
            setTimeout(() => {
              localStorage.setItem("habits", JSON.stringify(habits));
              renderHabits();
              updateDashboard();

              // Add move up animation to other cards
              document.querySelectorAll(".habit-card").forEach((card) => {
                if (card.dataset.id !== habitId) {
                  card.classList.add("move-up");
                }
              });
            }, 500);
          }, 300);
        }
      }

      // Updated renderHabits function
      function renderHabits() {
        const container = document.getElementById("habitsContainer");
        container.innerHTML = habits
          .map((habit, index) => {
            const completed = habit.progress.filter(Boolean).length;
            const progress = (completed / 30) * 100;
            const isCompleted = isFullyCompleted(habit.progress);
            const failButton =
              index === 0
                ? `
                <button class="btn btn-secondary btn-fail" onclick="failHabit('${
                  habit.id
                }')">
                    Fail in ${habit.progress.findIndex((day) => !day) + 1}
                </button>`
                : "";
            return `
        <div class="habit-card ${
          isCompleted ? "fully-completed-card" : ""
        }" data-id="${habit.id}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">${habit.name}</h5>
                <div>
                    <button class="btn btn-sm btn-primary edit-habit" data-id="${
                      habit.id
                    }">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-danger delete-habit" data-id="${
                      habit.id
                    }">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            <p class="descript-text">${habit.description}</p>
            <div class="d-flex justify-content-between align-items-center">
                <p>Time: ${habit.timeStart} - ${habit.timeEnd}</p>
                ${failButton}
            </div>
            <div class="progress mb-3">
                <div class="progress-bar ${
                  isCompleted ? "bg-success" : ""
                }" role="progressbar" style="width: ${progress}%">
                    ${progress.toFixed(1)}%
                </div>
            </div>
            <div class="checkbox-container">
                ${habit.progress
                  .map(
                    (status, index) => `
                     <div class="day-checkbox ${
                       status === true
                         ? "checked"
                         : status === "failed"
                         ? "failed"
                         : ""
                     }" 
       data-day="${index}" 
       onclick="toggleHabitDay('${habit.id}', ${index})">
    ${index + 1}
  </div>
                `
                  )
                  .join("")}
            </div>
        </div>
    `;
          })
          .join("");
        addResetButton("habits", habits, "habit");
      }

      // Todo List Management
      function createTodoForm() {
        const form = document.createElement("div");
        form.className = "todo-form mb-3";
        form.innerHTML = `
  <div class="mb-2">
      <input type="text" class="form-control todo-name" placeholder="Todo Name" required>
  </div>
  <div class="mb-2">
      <input type="text" class="form-control todo-goal" placeholder="Goal" required>
  </div>
  <div class="mb-2">
      <input type="number" class="form-control todo-days" placeholder="Number of days" required min="1" max="30">
  </div>
`;
        return form;
      }

      document.getElementById("addTodoForm").addEventListener("click", () => {
        const container = document.getElementById("todoForms");
        container.appendChild(createTodoForm());
      });

      // Update the saveTodos event listener
      document.getElementById("saveTodos").addEventListener("click", () => {
        const forms = document.querySelectorAll(".todo-form");

        if (isEditingTodo && editingTodoId !== null) {
          // Update existing todo
          const form = forms[0];
          const todo = todos.find((t) => t.id == editingTodoId);

          todo.name = form.querySelector(".todo-name").value;
          todo.goal = form.querySelector(".todo-goal").value;
          const newDays = parseInt(form.querySelector(".todo-days").value);

          // Adjust progress array if days changed
          if (newDays !== todo.days) {
            if (newDays > todo.days) {
              todo.progress = [
                ...todo.progress,
                ...Array(newDays - todo.days).fill(false),
              ];
            } else {
              todo.progress = todo.progress.slice(0, newDays);
            }
            todo.days = newDays;
          }

          isEditingTodo = false;
          editingTodoId = null;
        } else {
          // Add new todos
          forms.forEach((form) => {
            const days = parseInt(form.querySelector(".todo-days").value);
            const todo = {
              id: Date.now() + Math.random(),
              name: form.querySelector(".todo-name").value,
              goal: form.querySelector(".todo-goal").value,
              days: days,
              progress: Array(days).fill(false),
              createdAt: new Date().toISOString(),
            };
            todos.push(todo);
          });
        }

        localStorage.setItem("todos", JSON.stringify(todos));
        renderTodos();
        bootstrap.Modal.getInstance(
          document.getElementById("todoModal")
        ).hide();
        document.getElementById("todoForms").innerHTML = "";
      });

      // Helper function to check if all checkboxes are completed
      function isFullyCompleted(progressArray) {
        return progressArray.every((progress) => progress === true);
      }

      function toggleTodoDay(todoId, day) {
        const todo = todos.find((t) => t.id == todoId);
        if (todo) {
          todo.progress[day] = !todo.progress[day];

          // Find the todo card
          const todoCard = document.querySelector(
            `.todo-card[data-id="${todoId}"]`
          );
          const todoTitle = todoCard.querySelector("h5");

          // Check if all checkboxes are completed
          const isCompleted = isFullyCompleted(todo.progress);

          // Add completed styles
          todoCard.classList.add("completed-card");
          todoTitle.classList.add("completed-title");

          // Trigger move down animation
          setTimeout(() => {
            todoCard.classList.add("move-down");

            // Only reorder if not fully completed
            if (!isFullyCompleted(todo.progress)) {
              todos = todos.filter((t) => t.id != todoId);
              // Insert before any fully completed todos
              const completedIndex = todos.findIndex((t) =>
                isFullyCompleted(t.progress)
              );
              if (completedIndex === -1) {
                todos.push(todo);
              } else {
                todos.splice(completedIndex, 0, todo);
              }
            } else {
              // If fully completed, move to end
              todos = todos.filter((t) => t.id != todoId);
              todos.push(todo);
            }

            // Re-render after animation
            setTimeout(() => {
              localStorage.setItem("todos", JSON.stringify(todos));
              renderTodos();
              updateDashboard();

              // Add move up animation to other cards
              document.querySelectorAll(".todo-card").forEach((card) => {
                if (card.dataset.id !== todoId) {
                  card.classList.add("move-up");
                }
              });
            }, 500);
          }, 300);
        }
      }

      // Updated renderTodos function
      function renderTodos() {
        const container = document.getElementById("todosContainer");
        container.innerHTML = todos
          .map((todo, index) => {
            const completed = todo.progress.filter(Boolean).length;
            const progress = (completed / todo.days) * 100;
            const isCompleted = isFullyCompleted(todo.progress);
            const failButton =
              index === 0
                ? `
                <button class="btn btn-secondary btn-fail" onclick="failTodo('${
                  todo.id
                }')">
                    Fail in ${todo.progress.findIndex((day) => !day) + 1}
                </button>`
                : "";
            return `
        <div class="todo-card ${
          isCompleted ? "fully-completed-card" : ""
        }" data-id="${todo.id}">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">${todo.name}</h5>
                <div>
                    <button class="btn btn-sm btn-primary edit-todo" data-id="${
                      todo.id
                    }">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-danger delete-todo" data-id="${
                      todo.id
                    }">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            <p class="descript-text">Goal: ${todo.goal}</p>
            <div class="d-flex justify-content-between align-items-center">
                <p>Time: ${todo.timeStart} - ${todo.timeEnd}</p>
                ${failButton}
            </div>
            <div class="progress mb-3">
                <div class="progress-bar ${
                  isCompleted ? "bg-success" : ""
                }" role="progressbar" style="width: ${progress}%">
                    ${progress.toFixed(1)}%
                </div>
            </div>
            <div class="checkbox-container">
               ${todo.progress
                 .map(
                   (status, index) => `
  <div class="day-checkbox ${
    status === true ? "checked" : status === "failed" ? "failed" : ""
  }" 
       data-day="${index}" 
       onclick="toggleTodoDay('${todo.id}', ${index})">
    ${index + 1}
  </div>
`
                 )
                 .join("")}
            </div>
        </div>
      `;
          })
          .join("");
        addResetButton("todos", todos, "todo");
      }

      // Add this new function
      function addResetButton(containerId, itemsArray, itemType) {
        const container = document.getElementById(containerId);
        const existingButtonContainer =
          container.querySelector(".button-container");
        const addNewButton = container.querySelector(
          `[data-bs-target="#${itemType}Modal"]`
        );

        // Remove existing button container if exists
        if (existingButtonContainer) {
          existingButtonContainer.remove();
        }

        // Create container for buttons
        const buttonContainer = document.createElement("div");
        buttonContainer.className =
          "d-flex justify-content-between mb-3 button-container";

        // Always add the "Add New" button
        buttonContainer.appendChild(addNewButton);

        // Check if all items are completed
        const allCompleted =
          itemsArray.length > 0 &&
          itemsArray.every((item) => isFullyCompleted(item.progress));

        if (allCompleted) {
          const resetButton = document.createElement("button");
          resetButton.className = "btn btn-warning reset-button";
          resetButton.innerHTML = `Reset ${itemType}s`;
          resetButton.onclick = () => {
            showValidationModal(
              `Are you sure you want to reset all ${itemType}s?`,
              () => {
                itemsArray.forEach((item) => {
                  item.progress = Array(item.progress.length).fill(false);
                });
                localStorage.setItem(
                  `${itemType}s`,
                  JSON.stringify(itemsArray)
                );
                if (itemType === "habit") {
                  renderHabits();
                } else {
                  renderTodos();
                }
                updateDashboard();
              }
            );
          };

          // Add the reset button to the container
          buttonContainer.appendChild(resetButton);
        }

        // Insert the button container before the first element in the container
        container.insertBefore(buttonContainer, container.firstChild);
      }

      function failHabit(habitId) {
        const habit = habits.find((h) => h.id == habitId);
        if (habit) {
          const nextDayIndex = habit.progress.findIndex((day) => !day);
          if (nextDayIndex !== -1) {
            // Find the habit card and title
            const habitCard = document.querySelector(
              `.habit-card[data-id="${habitId}"]`
            );
            const habitTitle = habitCard.querySelector("h5");

            habit.progress[nextDayIndex] = "failed";

            // Add animation classes
            habitCard.classList.add("failed-card");
            habitTitle.classList.add("failed-title");

            // Trigger move down animation
            setTimeout(() => {
              habitCard.classList.add("move-down");

              // Reorder habits
              habits = habits.filter((h) => h.id != habitId);
              habits.push(habit);

              // Re-render after animation
              setTimeout(() => {
                localStorage.setItem("habits", JSON.stringify(habits));
                renderHabits();

                // Add move up animation to other cards
                document.querySelectorAll(".habit-card").forEach((card) => {
                  if (card.dataset.id !== habitId) {
                    card.classList.add("move-up");
                  }
                });
              }, 500);
            }, 300);
          }
        }
      }

      // Add failTodo function
      function failTodo(todoId) {
        const todo = todos.find((t) => t.id == todoId);
        if (todo) {
          const nextDayIndex = todo.progress.findIndex((day) => !day);
          if (nextDayIndex !== -1) {
            // Find the todo card and title
            const todoCard = document.querySelector(
              `.todo-card[data-id="${todoId}"]`
            );
            const todoTitle = todoCard.querySelector("h5");

            todo.progress[nextDayIndex] = "failed";

            // Add animation classes
            todoCard.classList.add("completed-card");
            todoTitle.classList.add("failed-title");

            // Trigger move down animation
            setTimeout(() => {
              todoCard.classList.add("move-down");

              // Reorder todos
              todos = todos.filter((t) => t.id != todoId);
              todos.push(todo);

              // Re-render after animation
              setTimeout(() => {
                localStorage.setItem("todos", JSON.stringify(todos));
                renderTodos();

                // Add move up animation to other cards
                document.querySelectorAll(".todo-card").forEach((card) => {
                  if (card.dataset.id !== todoId) {
                    card.classList.add("move-up");
                  }
                });
              }, 500);
            }, 300);
          }
        }
      }

      // Income & Expense Management
      document.getElementById("saveIncome").addEventListener("click", () => {
        const amount = parseFloat(
          document.getElementById("incomeAmount").value
        );
        if (amount > 0) {
          const transaction = {
            type: "income",
            amount: amount,
            date: new Date().toISOString(),
            description: "Income",
          };
          transactions.push(transaction);
          balance += amount;
          localStorage.setItem("transactions", JSON.stringify(transactions));
          animateNumber(document.getElementById("totalBalance"), balance);

          updateDashboard();
          bootstrap.Modal.getInstance(
            document.getElementById("incomeModal")
          ).hide();
          document.getElementById("incomeAmount").value = "";
        }
      });

      document.getElementById("saveExpense").addEventListener("click", () => {
        const amount = parseFloat(
          document.getElementById("expenseAmount").value
        );
        const reason = document.getElementById("expenseReason").value;
        const type = document.getElementById("expenseType").value;
        if (amount > 0 && reason) {
          const transaction = {
            type: "expense",
            amount: amount,
            date: new Date().toISOString(),
            description: reason,
            category: type,
          };
          transactions.push(transaction);
          balance -= amount;
          localStorage.setItem("transactions", JSON.stringify(transactions));
          animateNumber(document.getElementById("totalBalance"), balance);

          updateDashboard();
          bootstrap.Modal.getInstance(
            document.getElementById("expenseModal")
          ).hide();
          document.getElementById("expenseAmount").value = "";
          document.getElementById("expenseReason").value = "";
        }
      });

      // Wishlist Management
      document.getElementById("saveWishlist").addEventListener("click", () => {
        const name = document.getElementById("wishlistName").value;
        const price = parseFloat(
          document.getElementById("wishlistPrice").value
        );
        const image = document.getElementById("wishlistImage").value;
        if (name && price > 0) {
          const item = {
            id: Date.now(),
            name: name,
            price: price,
            image: image || "https://via.placeholder.com/150",
          };
          wishlist.push(item);
          localStorage.setItem("wishlist", JSON.stringify(wishlist));
          renderWishlist();
          bootstrap.Modal.getInstance(
            document.getElementById("wishlistModal")
          ).hide();
          document.getElementById("wishlistName").value = "";
          document.getElementById("wishlistPrice").value = "";
          document.getElementById("wishlistImage").value = "";
        }
      });

      function renderWishlist() {
        const container = document.getElementById("wishlistContainer");
        container.innerHTML = wishlist
          .map(
            (item) => `
  <div class="card wishlist-card">
      <img src="${item.image}" class="card-img-top wishlist-image" alt="${
              item.name
            }">
      <div class="card-body">
          <h5 class="card-title">${item.name}</h5>
          <p class="card-text">${formatCurrency(item.price)}</p>
          <button class="btn btn-sm btn-success ${
            balance >= item.price ? "" : "disabled"
          }"
                  onclick="buyWishlistItem(${item.id})">
              Buy
          </button>
          <button class="btn btn-sm btn-danger" onclick="deleteWishlistItem(${
            item.id
          })">
              Delete
          </button>
      </div>
  </div>
`
          )
          .join("");
      }

      // Clear History functionality
      document
        .getElementById("clearHistory")
        .addEventListener("click", function () {
          showValidationModal(
            "Are you sure you want to clear all transaction history? This cannot be undone.",
            () => {
              transactions = [];
              localStorage.setItem(
                "transactions",
                JSON.stringify(transactions)
              );
              updateDashboard();
              bootstrap.Toast.getInstance(
                document.getElementById("successToast")
              ).show();
            }
          );
        });

      let isEditing = false;
      let editingHabitId = null;

      // Edit Habit functionality
      function editHabit(id) {
        const habit = habits.find((h) => h.id == id);
        if (!habit) return;

        isEditing = true;
        editingHabitId = id;

        const modal = new bootstrap.Modal(
          document.getElementById("habitModal")
        );
        const formsContainer = document.getElementById("habitForms");
        const addButton = document.getElementById("addHabitForm");

        formsContainer.innerHTML = "";
        addButton.style.display = "none"; // Hide "Add Another" button

        const form = createHabitForm();
        form.querySelector(".habit-name").value = habit.name;
        form.querySelector(".habit-description").value = habit.description;
        form.querySelector(".habit-start").value = habit.timeStart;
        form.querySelector(".habit-end").value = habit.timeEnd;
        formsContainer.appendChild(form);

        modal.show();
      }

      let isEditingTodo = false;
      let editingTodoId = null;

      function editTodo(id) {
        const todo = todos.find((t) => t.id == id);
        if (!todo) return;

        isEditingTodo = true;
        editingTodoId = id;

        const modal = new bootstrap.Modal(document.getElementById("todoModal"));
        const formsContainer = document.getElementById("todoForms");
        const addButton = document.getElementById("addTodoForm");

        formsContainer.innerHTML = "";
        addButton.style.display = "none"; // Hide "Add Another" button

        const form = createTodoForm();
        form.querySelector(".todo-name").value = todo.name;
        form.querySelector(".todo-goal").value = todo.goal;
        form.querySelector(".todo-days").value = todo.days;
        formsContainer.appendChild(form);

        modal.show();
      }

      function buyWishlistItem(id) {
        const item = wishlist.find((i) => i.id === id);
        if (item && balance >= item.price) {
          showValidationModal(
            `Are you sure you want to buy ${item.name}?`,
            () => {
              balance -= item.price;
              transactions.push({
                type: "expense",
                amount: item.price,
                date: new Date().toISOString(),
                description: `Bought wishlist item: ${item.name}`,
              });
              wishlist = wishlist.filter((i) => i.id !== id);
              localStorage.setItem("wishlist", JSON.stringify(wishlist));
              localStorage.setItem(
                "transactions",
                JSON.stringify(transactions)
              );
              animateNumber(document.getElementById("totalBalance"), balance);
              renderWishlist();
              updateDashboard();
            }
          );
        } else if (balance < item.price) {
          showValidationModal(
            "Insufficient balance to purchase this item",
            () => {}
          );
        }
      }

      function deleteWishlistItem(id) {
        showValidationModal(
          "Are you sure you want to delete this item?",
          () => {
            wishlist = wishlist.filter((i) => i.id !== id);
            localStorage.setItem("wishlist", JSON.stringify(wishlist));
            renderWishlist();
          }
        );
      }

      function updateTransactionHistory() {
        const tbody = document.getElementById("historyTableBody");
        tbody.innerHTML = transactions
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .map(
            (transaction) => `
                    <tr>
                        <td>${new Date(
                          transaction.date
                        ).toLocaleDateString()}</td>
                        <td>${transaction.type}</td>
                        <td>${formatCurrency(transaction.amount)}</td>
                        <td>${transaction.description}</td>
                    </tr>
                `
          )
          .join("");
      }

      function animateNumber(targetElement, finalValue, duration = 1500) {
        const startValue =
          parseFloat(targetElement.textContent.replace(/[^0-9.-]/g, "")) || 0;
        const stepTime = 50; // Time for each step in ms
        const steps = Math.ceil(duration / stepTime);
        let currentStep = 0;

        // Add animated class
        targetElement.classList.add("animated");

        const randomize = () => {
          const randomValue = Math.random() * (finalValue * 2);
          targetElement.textContent = formatCurrency(randomValue.toFixed(2));
        };

        const interval = setInterval(() => {
          if (currentStep < steps) {
            randomize();
            currentStep++;
          } else {
            clearInterval(interval);
            targetElement.textContent = formatCurrency(finalValue); // Set final value
            targetElement.classList.remove("animated"); // Remove animation class
            // Ensure balance is saved after animation
            localStorage.setItem("balance", finalValue.toString());
          }
        }, stepTime);
      }

      function showValidationModal(message, onConfirm) {
        const modal = new bootstrap.Modal(
          document.getElementById("validationModal")
        );
        document.getElementById("validationMessage").textContent = message;

        const confirmButton = document.getElementById("validationConfirm");
        const newConfirmHandler = () => {
          onConfirm();
          modal.hide();
          confirmButton.removeEventListener("click", newConfirmHandler);
        };

        confirmButton.addEventListener("click", newConfirmHandler);
        modal.show();
      }

      function resetAllHabits() {
        showValidationModal(
          "Are you sure you want to reset progress for all habits?",
          () => {
            habits.forEach((habit) => {
              habit.progress = Array(habit.progress.length).fill(false);
            });
            localStorage.setItem("habits", JSON.stringify(habits));
            renderHabits();
            updateDashboard();
          }
        );
      }

      function deleteAllHabits() {
        showValidationModal(
          "Are you sure you want to delete all habits? This cannot be undone.",
          () => {
            habits = [];
            localStorage.setItem("habits", JSON.stringify(habits));
            renderHabits();
            updateDashboard();
          }
        );
      }

      function resetAllTodos() {
        showValidationModal(
          "Are you sure you want to reset progress for all todos?",
          () => {
            todos.forEach((todo) => {
              todo.progress = Array(todo.progress.length).fill(false);
            });
            localStorage.setItem("todos", JSON.stringify(todos));
            renderTodos();
            updateDashboard();
          }
        );
      }

      function deleteAllTodos() {
        showValidationModal(
          "Are you sure you want to delete all todos? This cannot be undone.",
          () => {
            todos = [];
            localStorage.setItem("todos", JSON.stringify(todos));
            renderTodos();
            updateDashboard();
          }
        );
      }

      // Initial setup
      document.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("habitModal")
          .addEventListener("hidden.bs.modal", () => {
            document.getElementById("addHabitForm").style.display = "block";
            isEditing = false;
            editingHabitId = null;
          });

        document
          .getElementById("todoModal")
          .addEventListener("hidden.bs.modal", () => {
            document.getElementById("addTodoForm").style.display = "block";
            isEditingTodo = false;
            editingTodoId = null;
          });
        // Add initial habit form
        document.getElementById("habitForms").appendChild(createHabitForm());

        // Add initial todo form
        document.getElementById("todoForms").appendChild(createTodoForm());

        // Render all components
        renderHabits();
        renderTodos();
        renderWishlist();
        animateNumber(document.getElementById("totalBalance"), balance);
        updateDashboard();
        updateDashboardTransactions();

        const dashboardTab = document.getElementById("dashboard-tab");
        dashboardTab.addEventListener("shown.bs.tab", () => {
          clearCharts();
          renderMonthlyChart();
          renderIncomeChart();
        });

        // Dark mode toggle
        const darkModeToggle = document.getElementById("darkModeToggle");

        // Check localStorage for dark mode preference
        if (localStorage.getItem("darkMode") === "true") {
          document.body.classList.add("dark-mode");
          darkModeToggle.checked = true;
        }

        // Toggle dark mode on switch change
        darkModeToggle.addEventListener("change", () => {
          if (darkModeToggle.checked) {
            document.body.classList.add("dark-mode");
            localStorage.setItem("darkMode", "true");
          } else {
            document.body.classList.remove("dark-mode");
            localStorage.setItem("darkMode", "false");
          }
          renderMonthlyChart(); // Re-render charts
          renderIncomeChart();
        });
      });

      // Event delegation for edit and delete buttons
      document
        .getElementById("habitsContainer")
        .addEventListener("click", (e) => {
          if (
            e.target.classList.contains("edit-habit") ||
            e.target.parentElement.classList.contains("edit-habit")
          ) {
            const id = e.target.closest(".edit-habit").dataset.id;
            editHabit(id);
          }
        });

      document
        .getElementById("todosContainer")
        .addEventListener("click", (e) => {
          if (
            e.target.classList.contains("edit-todo") ||
            e.target.parentElement.classList.contains("edit-todo")
          ) {
            const id = e.target.closest(".edit-todo").dataset.id;
            editTodo(id);
          }
        });

      document
        .getElementById("habitsContainer")
        .addEventListener("click", (e) => {
          if (
            e.target.classList.contains("delete-habit") ||
            e.target.parentElement.classList.contains("delete-habit")
          ) {
            const id = e.target.closest(".delete-habit").dataset.id;
            showValidationModal(
              "Are you sure you want to delete this habit?",
              () => {
                habits = habits.filter((h) => h.id != id);
                localStorage.setItem("habits", JSON.stringify(habits));
                renderHabits();
                updateDashboard();
              }
            );
          }
        });

      document
        .getElementById("todosContainer")
        .addEventListener("click", (e) => {
          if (
            e.target.classList.contains("delete-todo") ||
            e.target.parentElement.classList.contains("delete-todo")
          ) {
            const id = e.target.closest(".delete-todo").dataset.id;
            showValidationModal(
              "Are you sure you want to delete this todo?",
              () => {
                todos = todos.filter((t) => t.id != id);
                localStorage.setItem("todos", JSON.stringify(todos));
                renderTodos();
                updateDashboard();
              }
            );
          }
        });

      document.addEventListener("DOMContentLoaded", () => {
        const expenseTypeCards =
          document.querySelectorAll(".expense-type-card");
        const expenseTypeInput = document.getElementById("expenseType");

        expenseTypeCards.forEach((card) => {
          card.addEventListener("click", () => {
            // Remove "selected" class from all cards
            expenseTypeCards.forEach((c) => c.classList.remove("selected"));

            // Add "selected" class to the clicked card
            card.classList.add("selected");

            // Update the hidden input value
            expenseTypeInput.value = card.dataset.value;
          });
        });
      });
    </script>
  </body>
</html>
